# Copyright Vespa.ai. All rights reserved.
# Schema for RQ distance performance tests on SIFT 128-dim vectors

search test {
  document test {
    field id type int {
      indexing: attribute | summary
    }
    field filter type array<int> {
      indexing: attribute | summary
      attribute: fast-search
    }

    # RQ-encoded vector for Euclidean distance
    # 128 codes + 16 bytes metadata = 144 bytes packed
    field vec_rq_euclidean type tensor<int8>(x[144]) {
      indexing: attribute | index | summary
      index {
        hnsw {
          max-links-per-node: 16
          neighbors-to-explore-at-insert: 500
        }
      }
      attribute {
        distance-metric: rq_euclidean
      }
    }

    # RQ-encoded vector for Angular distance
    field vec_rq_angular type tensor<int8>(x[144]) {
      indexing: attribute | index | summary
      index {
        hnsw {
          max-links-per-node: 16
          neighbors-to-explore-at-insert: 500
        }
      }
      attribute {
        distance-metric: rq_angular
      }
    }

    # Original float vector for ground truth (brute force search)
    field vec_float type tensor<float>(x[128]) {
      indexing: attribute | summary
    }

    # Float vector with HNSW for comparison
    field vec_float_hnsw type tensor<float>(x[128]) {
      indexing: attribute | index | summary
      index {
        hnsw {
          max-links-per-node: 16
          neighbors-to-explore-at-insert: 500
        }
      }
    }
  }

  # Default rank profile for RQ Euclidean
  rank-profile default {
    first-phase {
      expression: closeness(label,nns)
    }
    approximate-threshold: 0.05
    num-threads-per-search: 1
  }

  # Rank profile for RQ Angular distance
  rank-profile rq-angular {
    first-phase {
      expression: closeness(label,nns)
    }
    approximate-threshold: 0.05
    num-threads-per-search: 1
  }

  # Rank profile for exact float search (ground truth)
  rank-profile float-exact {
    first-phase {
      expression: closeness(label,nns)
    }
    approximate-threshold: 0.05
    num-threads-per-search: 1
  }

  # Rank profile for float HNSW search
  rank-profile float-hnsw {
    first-phase {
      expression: closeness(label,nns)
    }
    approximate-threshold: 0.05
    num-threads-per-search: 1
  }

  rank-profile threads-1 inherits default {
    num-threads-per-search: 1
  }
  rank-profile threads-2 inherits default {
    num-threads-per-search: 2
  }
  rank-profile threads-4 inherits default {
    num-threads-per-search: 4
  }
  rank-profile threads-8 inherits default {
    num-threads-per-search: 8
  }
  rank-profile threads-16 inherits default {
    num-threads-per-search: 16
  }

  document-summary minimal {
    summary id {}
  }
}
